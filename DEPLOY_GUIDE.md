# 微信云托管部署指南

## 数据库配置 (PostgreSQL)

本项目需要连接 PostgreSQL 数据库。你可以选择使用腾讯云内网数据库，也可以使用外部（如阿里云 ECS）自建数据库。

### 方案 A：使用腾讯云数据库 (推荐)
适用于购买了腾讯云 PostgreSQL 实例的情况。
*   **连接方式**: 内网连接 (速度快，安全)
*   **HOST 配置**: 使用数据库的 **内网 IP**

### 方案 B：使用外部自建数据库 (如阿里云 ECS)
适用于你已有其他云厂商的服务器。
*   **连接方式**: 公网连接
*   **HOST 配置**: 使用 ECS 的 **公网 IP**

#### ⚠️ 外部数据库配置关键点
由于跨云访问，必须确保网络畅通：

1.  **ECS 安全组 (防火墙)**
    *   在阿里云控制台，找到 ECS 实例的安全组。
    *   添加 **入方向** 规则：允许协议 `TCP`，端口 `5432`，授权对象 `0.0.0.0/0` (或仅允许微信云托管的出口 IP，但那个 IP 可能会变，建议先全放开测试)。

2.  **PostgreSQL 配置**
    *   修改 `postgresql.conf`: 确保 `listen_addresses = '*'`
    *   修改 `pg_hba.conf`: 添加一行允许远程连接
        ```text
        # 允许任意 IP 使用密码连接 (生产环境建议限制 IP 段)
        host    all             all             0.0.0.0/0            md5
        ```
    *   **重启数据库**使配置生效: `sudo systemctl restart postgresql`

---

## 环境变量配置
在微信云托管控制台的「服务设置 -> 环境变量」中，添加以下配置：

| 变量名 | 示例值 | 说明 |
| :--- | :--- | :--- |
| `NODE_ENV` | `production` | 生产环境标识 |
| `PORT` | `80` | 容器监听端口 (默认80) |
| `DB_HOST` | `1.2.3.4` | **数据库公网 IP** (阿里云 ECS IP) |
| `DB_PORT` | `5432` | 数据库端口 |
| `DB_USER` | `postgres` | 数据库用户名 |
| `DB_PASSWORD` | `your_secure_password` | 数据库密码 |
| `DB_NAME` | `ai_starclass` | 数据库名称 (需预先创建) |

## 部署流程
1. 将代码推送到代码仓库。
2. 进入微信云托管控制台，选择服务。
3. 点击「发布」，选择代码仓库的分支进行构建和部署。
4. 部署成功后，服务将自动启动并尝试连接数据库。

## 注意事项
- **数据同步**: 当前代码配置了 `synchronize: true`，服务启动时会自动创建表结构。
- **网络延迟**: 跨云公网访问会有几毫秒到几十毫秒的延迟，通常对于小程序后端是可以接受的，但在高并发场景下可能成为瓶颈。
